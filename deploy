#!/bin/bash

# DiscussIt Full Deployment Script
# This script handles complete deployment including backend, frontend, and all necessary setup

# Exit immediately if any command fails
echo "üöÄ Starting DiscussIt Full Deployment..."

# Function to display error messages and exit
error_exit() {
    echo "‚ùå ERROR: $1" >&2
    exit 1
}

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if running as root
if [ "$EUID" -eq 0 ]; then
    echo "‚ö†Ô∏è  This script is running as root."
    read -p "üîí Are you sure you want to continue as root? (y/n) " continue_as_root
    if [[ ! "$continue_as_root" =~ ^[Yy]$ ]]; then
        echo "üõë Deployment aborted. Please run as a regular user with sudo privileges."
        exit 1
    fi
    echo "‚úÖ Continuing as root user..."
fi

# Check for required tools
echo "üîß Checking for required tools..."
for cmd in git python3 pip3 node npm; do
    if ! command_exists "$cmd"; then
        error_exit "$cmd is not installed. Please install it first."
    fi
done

# Set project directory
PROJECT_DIR="/root/7"
cd "$PROJECT_DIR" || error_exit "Failed to change to project directory: $PROJECT_DIR"

# Create virtual environment if it doesn't exist
echo "üêç Setting up Python environment..."
if [ ! -d "venv" ]; then
    echo "Creating virtual environment..."
    python3 -m venv venv || error_exit "Failed to create virtual environment"
fi

# Activate virtual environment
source venv/bin/activate || error_exit "Failed to activate virtual environment"

# Install Python dependencies
echo "üì¶ Installing Python dependencies..."
pip install -r requirements.txt || error_exit "Failed to install Python dependencies"

# Check for Angular frontend and build it
ANGULAR_DIR="static/frontend/app"
TARGET_ANGULAR_DIR="staticfiles/frontend/app"

echo "üîç Checking for Angular frontend..."
echo "   Looking in: $ANGULAR_DIR"

# Ensure Angular symlink exists
if [ ! -L "$ANGULAR_DIR" ] && [ -d "$TARGET_ANGULAR_DIR" ]; then
    echo "üîó Creating Angular frontend symlink..."
    mkdir -p "$(dirname "$ANGULAR_DIR")"
    ln -s "$TARGET_ANGULAR_DIR" "$ANGULAR_DIR"
    echo "‚úÖ Angular frontend symlink created"
fi

if [ -d "$ANGULAR_DIR" ] && [ -f "$ANGULAR_DIR/package.json" ]; then
    echo "‚úÖ Angular frontend found in: $ANGULAR_DIR"
    
    # Check if Angular directory is empty (indicating build files might be missing)
    if [ -z "$(ls -A "$ANGULAR_DIR/src" 2>/dev/null)" ]; then
        echo "‚ùå Angular source directory is empty: $ANGULAR_DIR/src"
        echo "‚ö†Ô∏è  WARNING: No Angular source files found! Skipping frontend build."
        echo "üí° Make sure you have the Angular source files in: $ANGULAR_DIR/src"
        echo "   Expected files: main.ts, app.component.ts, etc."
        ANGULAR_BUILD_SKIPPED=true
    else
        echo "‚úÖ Angular source files found in: $ANGULAR_DIR/src"
        ANGULAR_BUILD_SKIPPED=false
    fi
    
    # Only proceed with build if source files exist
    if [ "$ANGULAR_BUILD_SKIPPED" = true ]; then
        echo "üö´ Skipping Angular build due to missing source files"
    else
        # Check Node.js and npm versions
        echo "üîç Checking Node.js environment..."
        node_version=$(node --version 2>/dev/null || echo "not installed")
        npm_version=$(npm --version 2>/dev/null || echo "not installed")
        echo "   Node.js: $node_version"
        echo "   npm: $npm_version"
    
    # Check if versions meet requirements
    if ! command_exists node || ! command_exists npm; then
        error_exit "Node.js and npm are required for frontend build. Please install them first."
    fi
    
    # Install Angular CLI globally if not installed
    echo "üì¶ Installing Angular CLI..."
    npm install -g @angular/cli@21.0.1 || error_exit "Failed to install Angular CLI"
    
    # Navigate to Angular directory and install dependencies
    echo "üì¶ Installing Angular dependencies..."
    cd "$ANGULAR_DIR" || error_exit "Failed to change to Angular directory"
    npm install || error_exit "Failed to install Angular dependencies"
    
    # Build Angular frontend with detailed output
    echo "üî® Building Angular frontend..."
    echo "   This may take a few minutes..."
    echo "   Watching build progress..."
    
    # Start build with progress tracking
    BUILD_START=$(date +%s)
    npm run build 2>&1 | while read line; do
        echo "   $line"
    done
    
    BUILD_END=$(date +%s)
    BUILD_TIME=$((BUILD_END - BUILD_START))
    
    # Check if build was successful
    if [ ! -d "dist" ]; then
        error_exit "Angular build failed - no dist directory created"
    fi
    
    echo "‚úÖ Angular build completed successfully!"
    echo "üéâ Build Summary:"
    echo "   - Build time: ${BUILD_TIME} seconds"
    echo "   - Output directory: dist/"
    echo "   - Build status: SUCCESS"
    
    # Show some build statistics
    if [ -d "dist" ]; then
        BUILD_SIZE=$(du -sh dist | cut -f1)
        FILE_COUNT=$(find dist -type f | wc -l)
        echo "   - Build size: ${BUILD_SIZE}"
        echo "   - Files generated: ${FILE_COUNT}"
    fi
    
    # Copy built files to static directory
    echo "üìÅ Copying built files to static directory..."
    rsync -a dist/ ../static/ || error_exit "Failed to copy static files"
    
    # Return to project root
    cd "$PROJECT_DIR" || error_exit "Failed to return to project directory"
    fi
else
    echo "‚ùå Angular frontend not found in $ANGULAR_DIR"
    echo "‚ö†Ô∏è  WARNING: No Angular frontend will be built!"
    echo "üí° If you need the Angular frontend, make sure the directory exists with package.json."
    ANGULAR_BUILD_SKIPPED=true
fi

# Run database migrations
echo "üóÉÔ∏è Running database migrations..."
python manage.py migrate || error_exit "Failed to run database migrations"

# Create superuser (optional - can be skipped if user already exists)
read -p "üë§ Do you want to create a superuser? (y/n) " create_superuser
if [[ "$create_superuser" =~ ^[Yy]$ ]]; then
    echo "Creating superuser..."
    python manage.py createsuperuser || echo "‚ö†Ô∏è  Superuser creation failed or was skipped"
fi

# Validate required environment variables
if [ -f ".env" ]; then
    echo "üîë Validating environment variables..."
    source .env
    
    # Check for critical variables
    if [ -z "$SECRET_KEY" ]; then
        echo "‚ö†Ô∏è  SECRET_KEY not found in .env, generating a new one..."
        export SECRET_KEY=$(python -c "import secrets; print(secrets.token_urlsafe(50))")
        echo "SECRET_KEY=$SECRET_KEY" >> .env
    fi
    
    if [ -z "$DEBUG" ]; then
        echo "‚ÑπÔ∏è  DEBUG not set, defaulting to False for production"
        export DEBUG=False
    fi
fi

# Collect static files
echo "üé® Collecting static files..."
python manage.py collectstatic --noinput || error_exit "Failed to collect static files"

# Set up environment variables from .env
if [ -f ".env" ]; then
    echo "üîë Loading environment variables from .env..."
    # Load environment variables safely, ignoring comments and invalid lines
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip empty lines, comments, and lines without '='
        if [[ "$line" =~ ^[^#]*=.*$ ]] && [[ ! "$line" =~ ^[[:space:]]*# ]]; then
            export "$line" || echo "‚ö†Ô∏è  Failed to export: $line"
        fi
    done < .env
fi

# Configure for external access
echo "üåç Configuring for external access..."

# Update ALLOWED_HOSTS to include external access
if [ -f "discussit/settings.py" ]; then
    echo "Updating Django settings for external access..."
    # Add external host configuration if not present
    grep -q "ALLOWED_HOSTS.*\*" discussit/settings.py || \
        sed -i "s/ALLOWED_HOSTS.*/ALLOWED_HOSTS = ['51.15.115.36', 'localhost', '127.0.0.1']/" discussit/settings.py
fi

# Use production setup with Nginx and Gunicorn (default behavior)
use_production="y"
echo "üöÄ Using production setup with Nginx and Gunicorn..."
if [[ "$use_production" =~ ^[Yy]$ ]]; then
    echo "üîß Setting up production environment with Nginx and Gunicorn..."
    
    # Install system dependencies
    echo "üì¶ Installing production dependencies..."
    sudo apt update
    sudo apt install -y nginx certbot python3-certbot-nginx -qq || echo "‚ö†Ô∏è  Some packages may already be installed"
    
    # Set up Nginx configuration
    echo "üåê Configuring Nginx..."
    sudo cp nginx/prod.conf /etc/nginx/sites-available/discussit
    sudo ln -sf /etc/nginx/sites-available/discussit /etc/nginx/sites-enabled/
    sudo rm -f /etc/nginx/sites-enabled/default
    
    # Test and start Nginx
    echo "üîç Testing Nginx configuration..."
    sudo nginx -t && sudo systemctl restart nginx || error_exit "Nginx setup failed"
    
    # Set up Gunicorn systemd service
    echo "üî´ Setting up Gunicorn service..."
    sudo cat > /etc/systemd/system/discussit.service << EOF
[Unit]
Description=DiscussIt Gunicorn Server
After=network.target

[Service]
User=root
Group=www-data
WorkingDirectory=$PROJECT_DIR
Environment="PATH=$PROJECT_DIR/venv/bin"
ExecStart=$PROJECT_DIR/venv/bin/gunicorn --config $PROJECT_DIR/gunicorn_config.py discussit.wsgi:application
Restart=always

[Install]
WantedBy=multi-user.target
EOF
    
    # Enable and start Gunicorn
    echo "üöÄ Starting Gunicorn..."
    sudo systemctl daemon-reload
    sudo systemctl enable discussit
    sudo systemctl start discussit
    
    # Configure firewall for production
    echo "üî• Configuring firewall for production access..."
    if command_exists ufw; then
        sudo ufw allow 'Nginx Full' || echo "‚ö†Ô∏è  Firewall rule may already exist"
        sudo ufw allow 80/tcp || echo "‚ö†Ô∏è  Firewall rule may already exist"
        sudo ufw allow 443/tcp || echo "‚ö†Ô∏è  Firewall rule may already exist"
        sudo ufw --force enable || echo "‚ö†Ô∏è  Firewall may already be enabled"
    elif command_exists firewall-cmd; then
        sudo firewall-cmd --add-service=http --permanent
        sudo firewall-cmd --add-service=https --permanent
        sudo firewall-cmd --reload
    else
        echo "‚ö†Ô∏è  No recognized firewall found. You may need to manually open ports 80 and 443."
    fi
    
    # Set up SSL (if DNS is configured)
    echo "üîí Attempting SSL setup..."
    if command_exists certbot; then
        sudo certbot --nginx -d 51.15.115.36 --non-interactive --agree-tos -m admin@discussit.com || \
            echo "‚ö†Ô∏è  SSL setup failed. The site is still accessible via HTTP."
    else
        echo "‚ö†Ô∏è  Certbot not installed. Install with: sudo apt install certbot python3-certbot-nginx"
    fi
    
    echo "‚úÖ Production setup completed!"

# Wait for database to be ready
echo "‚è≥ Waiting for database to be ready..."
sleep 10

# Run any additional setup commands
if [ -f "commands.txt" ]; then
    echo "üìã Running additional setup commands..."
    while read -r cmd; do
        if [[ "$cmd" != "" && "$cmd" != "#"* && "$cmd" != "="* && "$cmd" != "USING"* && "$cmd" != "==="* ]]; then
            echo "Running: $cmd"
            eval "$cmd" || echo "‚ö†Ô∏è  Command failed: $cmd"
        fi
    done < commands.txt
fi

# Check if services are running
echo "üîç Checking service status..."
echo "üéâ Production services are running with Nginx and Gunicorn!"

fi

# Display deployment information based on setup type
if [[ "$use_production" =~ ^[Yy]$ ]]; then
    echo "üéâ Production Deployment completed successfully!"
    echo ""
    echo "üìä Deployment Summary:"
    if [ "$ANGULAR_BUILD_SKIPPED" = true ]; then
        echo "- Frontend build: Skipped (no source files)"
    else
        echo "- Frontend build: Completed successfully"
    fi
    echo "- Python environment: Ready"
    echo "- Dependencies: Installed"
    echo "- Database: Migrated"
    echo "- Static files: Collected"
    echo "- Nginx: Configured and running"
    echo "- Gunicorn: Configured and running"
    echo "- Firewall: Configured for HTTP/HTTPS"
    echo ""
    echo "üåê Application Access:"
    echo "- HTTP: http://51.15.115.36"
    echo "- HTTPS: https://51.15.115.36 (if SSL setup succeeded)"
    echo "- Admin: http://51.15.115.36/admin/"
    echo "- API Docs: http://51.15.115.36/api/swagger/"
    echo ""
    echo "üí° Management Commands:"
    echo "- Restart services: sudo systemctl restart discussit nginx"
    echo "- View logs: sudo journalctl -u discussit -f"
    echo "- Check status: sudo systemctl status discussit"
    echo "- Reload Nginx: sudo systemctl reload nginx"
    echo "- Check Nginx status: sudo systemctl status nginx"
    echo "- Renew SSL certificates: sudo certbot renew"
    echo ""
    echo "üí° Next steps:"
    echo "1. Access the admin panel at /admin"
    echo "2. Set up monitoring and backups"
    echo "3. Configure email settings for production"
    echo "4. Set up regular database backups"
fi

echo ""
echo "üìö Documentation: See README.md for more information"