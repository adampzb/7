#!/bin/bash

# DiscussIt Full Deployment Script
# This script handles complete deployment including backend, frontend, and all necessary setup

# Exit immediately if any command fails
echo "ğŸš€ Starting DiscussIt Full Deployment..."

# Function to display error messages and exit
error_exit() {
    echo "âŒ ERROR: $1" >&2
    exit 1
}

# Function to check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check if running as root
if [ "$EUID" -eq 0 ]; then
    echo "âš ï¸  This script is running as root."
    read -p "ğŸ”’ Are you sure you want to continue as root? (y/n) " continue_as_root
    if [[ ! "$continue_as_root" =~ ^[Yy]$ ]]; then
        echo "ğŸ›‘ Deployment aborted. Please run as a regular user with sudo privileges."
        exit 1
    fi
    echo "âœ… Continuing as root user..."
fi

# Check for required tools
echo "ğŸ”§ Checking for required tools..."
for cmd in git python3 pip3 node npm docker docker-compose; do
    if ! command_exists "$cmd"; then
        error_exit "$cmd is not installed. Please install it first."
    fi
done

# Set project directory
PROJECT_DIR="/root/7"
cd "$PROJECT_DIR" || error_exit "Failed to change to project directory: $PROJECT_DIR"

# Create virtual environment if it doesn't exist
echo "ğŸ Setting up Python environment..."
if [ ! -d "venv" ]; then
    echo "Creating virtual environment..."
    python3 -m venv venv || error_exit "Failed to create virtual environment"
fi

# Activate virtual environment
source venv/bin/activate || error_exit "Failed to activate virtual environment"

# Install Python dependencies
echo "ğŸ“¦ Installing Python dependencies..."
pip install -r requirements.txt || error_exit "Failed to install Python dependencies"

# Install Node.js dependencies (if package.json exists)
if [ -f "package.json" ]; then
    echo "ğŸ“¦ Installing Node.js dependencies..."
    npm install || error_exit "Failed to install Node.js dependencies"
    
    # Build Angular frontend
    echo "ğŸ”¨ Building Angular frontend..."
    npm run build || error_exit "Failed to build Angular frontend"
fi

# Run database migrations
echo "ğŸ—ƒï¸ Running database migrations..."
python manage.py migrate || error_exit "Failed to run database migrations"

# Create superuser (optional - can be skipped if user already exists)
read -p "ğŸ‘¤ Do you want to create a superuser? (y/n) " create_superuser
if [[ "$create_superuser" =~ ^[Yy]$ ]]; then
    echo "Creating superuser..."
    python manage.py createsuperuser || echo "âš ï¸  Superuser creation failed or was skipped"
fi

# Collect static files
echo "ğŸ¨ Collecting static files..."
python manage.py collectstatic --noinput || error_exit "Failed to collect static files"

# Set up environment variables from .env
if [ -f ".env" ]; then
    echo "ğŸ”‘ Loading environment variables from .env..."
    # Load environment variables safely, ignoring comments and invalid lines
    while IFS= read -r line || [[ -n "$line" ]]; do
        # Skip empty lines, comments, and lines without '='
        if [[ "$line" =~ ^[^#]*=.*$ ]] && [[ ! "$line" =~ ^[[:space:]]*# ]]; then
            export "$line" || echo "âš ï¸  Failed to export: $line"
        fi
    done < .env
fi

# Configure for external access
echo "ğŸŒ Configuring for external access..."

# Update ALLOWED_HOSTS to include external access
if [ -f "discussit/settings.py" ]; then
    echo "Updating Django settings for external access..."
    # Add external host configuration if not present
    grep -q "ALLOWED_HOSTS.*\*" discussit/settings.py || \
        sed -i "s/ALLOWED_HOSTS.*/ALLOWED_HOSTS = ['*']/" discussit/settings.py
fi

# Check if we should use production setup
read -p "ğŸš€ Use production setup with Nginx and Gunicorn? (y/n) " use_production
if [[ "$use_production" =~ ^[Yy]$ ]]; then
    echo "ğŸ”§ Setting up production environment with Nginx and Gunicorn..."
    
    # Install system dependencies
    echo "ğŸ“¦ Installing production dependencies..."
    sudo apt update
    sudo apt install -y nginx certbot python3-certbot-nginx -qq || echo "âš ï¸  Some packages may already be installed"
    
    # Set up Nginx configuration
    echo "ğŸŒ Configuring Nginx..."
    sudo cp nginx/prod.conf /etc/nginx/sites-available/discussit
    sudo ln -sf /etc/nginx/sites-available/discussit /etc/nginx/sites-enabled/
    sudo rm -f /etc/nginx/sites-enabled/default
    
    # Test and start Nginx
    echo "ğŸ” Testing Nginx configuration..."
    sudo nginx -t && sudo systemctl restart nginx || error_exit "Nginx setup failed"
    
    # Set up Gunicorn systemd service
    echo "ğŸ”« Setting up Gunicorn service..."
    sudo cat > /etc/systemd/system/discussit.service << EOF
[Unit]
Description=DiscussIt Gunicorn Server
After=network.target

[Service]
User=root
Group=www-data
WorkingDirectory=$PROJECT_DIR
Environment="PATH=$PROJECT_DIR/venv/bin"
ExecStart=$PROJECT_DIR/venv/bin/gunicorn --config $PROJECT_DIR/gunicorn_config.py discussit.wsgi:application
Restart=always

[Install]
WantedBy=multi-user.target
EOF
    
    # Enable and start Gunicorn
    echo "ğŸš€ Starting Gunicorn..."
    sudo systemctl daemon-reload
    sudo systemctl enable discussit
    sudo systemctl start discussit
    
    # Configure firewall for production
    echo "ğŸ”¥ Configuring firewall for production access..."
    if command_exists ufw; then
        sudo ufw allow 'Nginx Full' || echo "âš ï¸  Firewall rule may already exist"
        sudo ufw allow 80/tcp || echo "âš ï¸  Firewall rule may already exist"
        sudo ufw allow 443/tcp || echo "âš ï¸  Firewall rule may already exist"
        sudo ufw --force enable || echo "âš ï¸  Firewall may already be enabled"
    elif command_exists firewall-cmd; then
        sudo firewall-cmd --add-service=http --permanent
        sudo firewall-cmd --add-service=https --permanent
        sudo firewall-cmd --reload
    else
        echo "âš ï¸  No recognized firewall found. You may need to manually open ports 80 and 443."
    fi
    
    # Set up SSL (if DNS is configured)
    echo "ğŸ”’ Attempting SSL setup..."
    if command_exists certbot; then
        sudo certbot --nginx -d 51.15.115.36 --non-interactive --agree-tos -m admin@discussit.com || \
            echo "âš ï¸  SSL setup failed. The site is still accessible via HTTP."
    else
        echo "âš ï¸  Certbot not installed. Install with: sudo apt install certbot python3-certbot-nginx"
    fi
    
    echo "âœ… Production setup completed!"
else
    # Use Docker setup (original behavior)
    echo "ğŸ³ Starting Docker services..."
    docker compose up -d || error_exit "Failed to start Docker services"
    
    # Configure firewall for Docker access
    echo "ğŸ”¥ Configuring firewall for Docker access..."
    if command_exists ufw; then
        sudo ufw allow 8000/tcp || echo "âš ï¸  Firewall rule may already exist"
        sudo ufw reload || echo "âš ï¸  Firewall reload failed"
    elif command_exists firewall-cmd; then
        sudo firewall-cmd --add-port=8000/tcp --permanent || echo "âš ï¸  Firewall rule may already exist"
        sudo firewall-cmd --reload || echo "âš ï¸  Firewall reload failed"
    else
        echo "âš ï¸  No recognized firewall found. You may need to manually open port 8000."
    fi
fi

# Wait for database to be ready
echo "â³ Waiting for database to be ready..."
sleep 10

# Run any additional setup commands
if [ -f "commands.txt" ]; then
    echo "ğŸ“‹ Running additional setup commands..."
    while read -r cmd; do
        if [[ "$cmd" != "" && "$cmd" != "#"* && "$cmd" != "="* && "$cmd" != "USING"* && "$cmd" != "==="* ]]; then
            # Skip docker run commands to avoid port conflicts with docker compose
            if [[ "$cmd" != "docker run"* ]]; then
                echo "Running: $cmd"
                eval "$cmd" || echo "âš ï¸  Command failed: $cmd"
            else
                echo "âš ï¸  Skipping 'docker run' command to avoid port conflicts (using docker compose instead)"
            fi
        fi
    done < commands.txt
fi

# Check if services are running
echo "ğŸ” Checking service status..."
docker compose ps

# Display deployment information based on setup type
if [[ "$use_production" =~ ^[Yy]$ ]]; then
    echo "ğŸ‰ Production Deployment completed successfully!"
    echo ""
    echo "ğŸ“Š Deployment Summary:"
    echo "- Python environment: Ready"
    echo "- Dependencies: Installed"
    echo "- Database: Migrated"
    echo "- Static files: Collected"
    echo "- Nginx: Configured and running"
    echo "- Gunicorn: Configured and running"
    echo "- Firewall: Configured for HTTP/HTTPS"
    echo ""
    echo "ğŸŒ Application Access:"
    echo "- HTTP: http://51.15.115.36"
    echo "- HTTPS: https://51.15.115.36 (if SSL setup succeeded)"
    echo "- Admin: http://51.15.115.36/admin/"
    echo "- API Docs: http://51.15.115.36/api/swagger/"
    echo ""
    echo "ğŸ’¡ Management Commands:"
    echo "- Restart services: sudo systemctl restart discussit nginx"
    echo "- View logs: sudo journalctl -u discussit -f"
    echo "- Check status: sudo systemctl status discussit"
else
    echo "ğŸ‰ Development Deployment completed successfully!"
    echo ""
    echo "ğŸ“Š Deployment Summary:"
    echo "- Python environment: Ready"
    echo "- Dependencies: Installed"
    echo "- Database: Migrated"
    echo "- Static files: Collected"
    echo "- Docker services: Running"
    echo ""
    echo "ğŸŒ Application should be available at:"
    echo "- Local: http://localhost:8000"
    echo "- External: http://51.15.115.36:8000 (if firewall allows)"
    echo ""
    echo "ğŸ’¡ Next steps:"
    echo "1. Access the admin panel at /admin"
    echo "2. For production, consider using the production setup"
    echo "3. Set up monitoring and backups"
fi

echo ""
echo "ğŸ“š Documentation: See README.md for more information"